{"version":3,"sources":["../../api/register.js"],"names":["userApi","create","res","body","console","log","CompanyModel","schema","user","userData","type","UserModel","name","email","password","avatar","phone_number","phoneNumber","location","json","status","message","devMessage","end","authToken","jwt","sign","sub","_id","userType","config","jwtSecret","expiresIn","authTokenExpiresIn","refreshToken","refreshTokenExpiresIn","authTokens","push","refreshTokens","save","then","data","catch","error","code"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA;AACA;AACA;AACA;AACA;;AAEA,IAAMA,UAAU,wCAAS;AACxBC,OADwB,wBACPC,GADO,EACF;AAAA,MAAbC,IAAa,QAAbA,IAAa;;AACrB;AACAC,UAAQC,GAAR,CAAYC,kBAAaC,MAAzB;AACA,MAAIC,OAAO,IAAX;;AAEA,MAAMC,WAAWN,KAAKM,QAAtB;;AAEA,UAAON,KAAKO,IAAZ;AACC,QAAK,MAAL;AACCF,WAAO,IAAIG,cAAJ,CAAc,EAACC,MAAMH,SAASG,IAAhB,EAAsBC,OAAOJ,SAASI,KAAtC,EAA6CC,UAAUL,SAASK,QAAhE,EAA0EC,QAAQN,SAASM,MAA3F,EAAmGC,cAAcP,SAASQ,WAA1H,EAAd,CAAP;AACA;AACD,QAAK,SAAL;AACCT,WAAO,IAAIF,iBAAJ,CAAiB,EAACM,MAAMH,SAASG,IAAhB,EAAsBC,OAAOJ,SAASI,KAAtC,EAA6CC,UAAUL,SAASK,QAAhE,EAA0EC,QAAQN,SAASM,MAA3F,EAAmGC,cAAcP,SAASQ,WAA1H,EAAuIC,UAAUT,SAASS,QAA1J,EAAjB,CAAP;AACA;AACD;AACChB,QAAIiB,IAAJ,CAAS;AACRC,aAAQ,CAAC,CADD;AAERC,cAAS,EAFD;AAGRC,iBAAY;AAHJ,KAAT;AAKApB,QAAIqB,GAAJ;AAbF;AAeA,MAAIC,YAAY,YAAYC,uBAAIC,IAAJ,CAAS,EAAEC,KAAKnB,KAAKoB,GAAZ,EAAiBlB,MAAM,MAAvB,EAA+BmB,UAAU1B,KAAKO,IAA9C,EAAT,EAA+DoB,iBAAOC,SAAtE,EAAiF;AAC7GC,cAAWF,iBAAOG;AAD2F,GAAjF,CAA5B;;AAIA,MAAIC,eAAeT,uBAAIC,IAAJ,CAAS,EAAEC,KAAKnB,KAAKoB,GAAZ,EAAiBlB,MAAM,SAAvB,EAAkCmB,UAAU1B,KAAKO,IAAjD,EAAT,EAAkEoB,iBAAOC,SAAzE,EAAoF;AACvGC,cAAWF,iBAAOK;AADqF,GAApF,CAAnB;;AAIA3B,OAAK4B,UAAL,CAAgBC,IAAhB,CAAqBb,SAArB;AACAhB,OAAK8B,aAAL,CAAmBD,IAAnB,CAAwBH,YAAxB;;AAEA1B,OAAK+B,IAAL,GACEC,IADF,CACQ,YAAM;AACZtC,OAAIiB,IAAJ,CAAS;AACRC,YAAQ,CADA;AAERC,aAAS,0BAFD;AAGRoB,UAAM;AACLZ,eAAU1B,KAAKO,IADV;AAELc,yBAFK;AAGLQ,gBAAWF,iBAAOG,kBAHb;AAILC;AAJK;AAHE,IAAT;AAUA,GAZF,EAaEQ,KAbF,CAaQ,iBAAS;AACf,OAAIrB,UAAU,uBAAd;AACA,OAAGsB,MAAMC,IAAN,IAAc,KAAjB,EAAwBvB,UAAU,gCAAV;AACxBnB,OAAIiB,IAAJ,CAAS;AACRC,YAAQuB,MAAMC,IAAN,IAAc,CAAC,CADf;AAERvB,oBAFQ;AAGR;AACAC,gBAAYqB;AAJJ,IAAT;AAMA,GAtBF;AAuBA;AAzDuB,CAAT,CAAhB;;kBA4De3C,O","file":"register.js","sourcesContent":["import resource from 'resource-router-middleware';\nimport UserModel from '../models/user';\nimport CompanyModel from '../models/company';\nimport jwt from 'jsonwebtoken';\nimport config from '../config';\n\n// const addFullNameToBody = body => merge({\n// \tname: {\n// \t\tfull: `${get('name.first', body)} ${get('name.last', body)}`\n// \t},\n// }, body);\n\nconst userApi = resource({\n\tcreate({ body }, res) {\n\t\t//let user = new UserModel(addFullNameToBody(body));\n\t\tconsole.log(CompanyModel.schema);\n\t\tlet user = null;\n\n\t\tconst userData = body.userData;\n\n\t\tswitch(body.type){\n\t\t\tcase 'user': \n\t\t\t\tuser = new UserModel({name: userData.name, email: userData.email, password: userData.password, avatar: userData.avatar, phone_number: userData.phoneNumber});\n\t\t\t\tbreak;\n\t\t\tcase 'company':\n\t\t\t\tuser = new CompanyModel({name: userData.name, email: userData.email, password: userData.password, avatar: userData.avatar, phone_number: userData.phoneNumber, location: userData.location});\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tres.json({\n\t\t\t\t\tstatus: -1,\n\t\t\t\t\tmessage: \"\",\n\t\t\t\t\tdevMessage: \"Invalid or missing type\"\n\t\t\t\t});\n\t\t\t\tres.end();\n\t\t}\n\t\tvar authToken = \"bearer \" + jwt.sign({ sub: user._id, type: 'auth', userType: body.type }, config.jwtSecret, {\n\t\texpiresIn: config.authTokenExpiresIn\n\t\t});\n\n\t\tvar refreshToken = jwt.sign({ sub: user._id, type: 'refresh', userType: body.type }, config.jwtSecret, {\n\t\texpiresIn: config.refreshTokenExpiresIn\n\t\t});\n\n\t\tuser.authTokens.push(authToken);\n\t\tuser.refreshTokens.push(refreshToken);\n\n\t\tuser.save()\n\t\t\t.then( () => {\n\t\t\t\tres.json({\n\t\t\t\t\tstatus: 0,\n\t\t\t\t\tmessage: 'Registration successfull',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tuserType: body.type,\n\t\t\t\t\t\tauthToken,\n\t\t\t\t\t\texpiresIn: config.authTokenExpiresIn,\n\t\t\t\t\t\trefreshToken\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tlet message = \"Registration failture\";\n\t\t\t\tif(error.code == 11000) message = \"User with such email is exists\";\n\t\t\t\tres.json({\n\t\t\t\t\tstatus: error.code || -1,\n\t\t\t\t\tmessage,\n\t\t\t\t\t//devMessage: resMessage(error.message)\n\t\t\t\t\tdevMessage: error,\n\t\t\t\t})\n\t\t\t})\n\t},\n});\n\nexport default userApi;\n"]}