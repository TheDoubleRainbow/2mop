{"version":3,"sources":["../../api/auth.js"],"names":["authApi","create","res","body","email","password","promiseArray","push","Promise","resolve","reject","UserModel","findOne","select","authTokens","refreshTokens","then","result","CompanyModel","all","send","status","message","userType","console","log","comparePassword","err","isMatch","authToken","jwt","sign","sub","_id","type","config","jwtSecret","expiresIn","authTokenExpiresIn","refreshToken","refreshTokenExpiresIn","save","json","success","toString","data","catch","delete"],"mappings":"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","file":"auth.js","sourcesContent":["import { isEmpty } from 'lodash/fp';\nimport resource from 'resource-router-middleware';\nimport jwt from 'jsonwebtoken';\nimport UserModel from '../models/user';\nimport CompanyModel from '../models/company';\nimport config from '../config';\n\nconst authApi = resource({\n\tcreate({ body: { email, password } }, res) {\n    let promiseArray = []\n    promiseArray.push(new Promise((resolve, reject) => {\n      UserModel.findOne({ email }).select({password: 1, authTokens: 1, refreshTokens: 1}).then(result => {\n        resolve(result);\n      })\n    }));\n    promiseArray.push(new Promise((resolve, reject) => {\n      CompanyModel.findOne({ email }).select({password: 1, authTokens: 1, refreshTokens: 1}).then(result => {\n        resolve(result);\n      })\n    }))\n      \n    //promiseArray.push(CompanyModel.findOne({ email }).select(\"+password\"));\n    Promise.all(promiseArray)\n      .then(result => {\n        if (isEmpty(result[0]) && isEmpty(result[1])) {\n          return res.send({\n            status: 3,\n            message: 'Authentication failed. User not found.'\n          })\n        }\n\n        let userType = \"\";\n\n        if (!isEmpty(result[0])) {\n          result = result[0];\n          userType = \"user\";\n        }\n\n        if (!isEmpty(result[1])) {\n          result = result[1];\n          userType = \"company\";\n        }\n\n        console.log('result ', result)\n\n        result.comparePassword(password, (err, isMatch) => {\n          if (isMatch && !err) {\n            var authToken = \"bearer \" + jwt.sign({ sub: result._id, type: 'auth', userType }, config.jwtSecret, {\n              expiresIn: config.authTokenExpiresIn\n            });\n\n            var refreshToken = jwt.sign({ sub: result._id, type: 'refresh', userType }, config.jwtSecret, {\n              expiresIn: config.refreshTokenExpiresIn\n            });\n\n            result.authTokens.push(authToken);\n            result.refreshTokens.push(refreshToken);\n            return result.save((err)=>{\n              if(err){\n                res.json({success: false, message: err.toString});\n              } else {\n                res.json({\n                  success: true,\n                  message: 'Authentication successfull',\n                  data: {\n                    userType,\n                    authToken,\n                    expiresIn: config.authTokenExpiresIn,\n                    refreshToken,\n                  }\n\n                });\n              }\n            })\n          }\n\n          res.status(401).send({\n            success: false,\n            message: 'Authentication failed. Passwords did not match.'\n          });\n        });\n      })\n      .catch(err => res.send(err.toString()))\n  },\n  delete() {\n\n  }\n});\n\nexport default authApi;\n"]}